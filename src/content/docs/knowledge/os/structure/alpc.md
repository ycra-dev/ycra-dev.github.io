---
title: "ALPC (Advanced Local Procedure Call)"
description: "Windows에서 동일 머신 내 프로세스 간 고성능 메시지 전달을 위한 IPC 메커니즘"
tags: ["OS", "Windows", "IPC"]
created: 2026-01-27
updated: 2026-01-27
draft: true
slug: knowledge/os/alpc
sidebar:
  order: 12
---

## 핵심 개념

ALPC(Advanced Local Procedure Call)는 Windows에서 **동일 머신 내 프로세스 간 고성능 메시지 전달**을 위한 IPC 메커니즘이다. 연결 포트와 통신 포트 쌍을 통해 동기/비동기 통신을 지원한다.

비유하면 회사 내부 메신저와 같다. 연결 포트는 "고객 지원 채널 열기"이고, 통신 포트 쌍은 "1:1 채팅방"이다. 짧은 메시지는 채팅창에 바로 표시(커널 큐)하고, 대용량 파일은 공유 폴더 링크로 전송(섹션 객체)한다.

### 왜 필요한가?

- RPC(Remote Procedure Call)는 네트워크 통신까지 고려한 범용 프로토콜이라 로컬 통신에는 오버헤드가 크다
- 시스템 핵심 서비스(환경 서브시스템 등)가 RPC에 의존하면 순환 의존성이 발생한다
- Windows는 클라이언트-서버 모델을 광범위하게 사용한다 (csrss, 인증 서비스, 네트워크 서비스 등)
- 이들을 위한 경량 로컬 IPC가 필요했다

## 동작 원리

핵심 가정은 **로컬 프로세스 간 통신은 네트워크 없이 커널을 통해 직접 수행할 수 있다**는 것이다.

### 1. 연결 설정

```
┌─────────────────┐                    ┌─────────────────┐
│   Client        │                    │   Server        │
│   Process       │                    │   (e.g. csrss)  │
└────────┬────────┘                    └────────┬────────┘
         │                                      │
         │ 1. 연결 포트 핸들 열기               │ 0. 연결 포트 생성
         │─────────────────────────────────────>│    (NtCreatePort)
         │                                      │
         │ 2. 연결 요청                         │
         │─────────────────────────────────────>│
         │                                      │
         │                                      │ 3. 연결 수락
         │                                      │
         │<──── ALPC가 통신 포트 쌍 생성 ──────>│
         │                                      │
┌────────┴────────┐                    ┌────────┴────────┐
│ Communication   │                    │ Communication   │
│ Port (Client)   │<──── 메시지 ──────>│ Port (Server)   │
└─────────────────┘                    └─────────────────┘
```

- 서버가 전역 공개 **연결 포트(connection port)** 객체를 게시한다
- 클라이언트가 연결 포트에 핸들을 열고 연결 요청을 전송한다
- 서버가 수락하면 ALPC가 **통신 포트(communication port)** 쌍을 생성한다
- 클라이언트와 서버 각각 자신의 통신 포트 핸들을 획득한다

### 2. 메시지 유형

- **데이터그램(Datagram)**: UDP처럼 응답이 불필요한 메시지
- **요청(Request)**: 반드시 응답이 필요한 메시지

### 3. 통신 모드

- **동기**: 한 쪽이 요청/응답 대기 중 블로킹
- **비동기**: 스레드 풀 활용, 메시지 도착 시 콜백 실행

### 4. 메시지 전달 기법

메시지 크기에 따라 전달 방식이 달라진다.

**소형 메시지 (< 64KB):**

```
┌────────┐    복사    ┌────────┐    복사    ┌────────┐
│ Client │ ────────> │ Kernel │ ────────> │ Server │
│ Buffer │           │ Queue  │           │ Buffer │
└────────┘           └────────┘           └────────┘
  ※ 단점: 이중 버퍼링, 커널 메모리 점유
```

커널 메시지 큐에 복사하는 이중 버퍼링 방식이다.

**대형 메시지 (섹션 객체):**

```
┌────────┐                              ┌────────┐
│ Client │                              │ Server │
│ VA Map │ <──── 같은 물리 메모리 ────> │ VA Map │
└───┬────┘           │                  └───┬────┘
    │                v                      │
    │         ┌────────────┐                │
    │         │ Section    │                │
    └────────>│ Object     │<───────────────┘
              │ (Shared)   │
              └────────────┘
  ※ 장점: 복사 없음, 물리 메모리 공유
```

공유 메모리 섹션 객체를 사용하여 물리 메모리를 공유하므로 복사가 발생하지 않는다.

## 예시

사용자가 프로그램을 실행할 때의 ALPC 통신 시나리오:

1. 사용자가 프로그램 실행 요청
2. 클라이언트(explorer.exe)가 csrss의 연결 포트에 연결 요청
3. csrss가 수락하면 통신 포트 쌍 생성
4. 클라이언트가 "새 프로세스 등록" 요청 메시지 전송
5. csrss가 처리 후 응답 메시지 반환

### 장단점

- **장점**: 로컬 RPC 전송 계층으로 사용 시 네트워크 오버헤드 제거, 대형 메시지는 섹션 객체로 제로카피 달성, 동기/비동기 모드 선택 가능, 커널 서버의 경우 콜백 메커니즘으로 즉시 KT 전환 가능
- **단점**: 소형 메시지의 이중 버퍼링 오버헤드, 서버 응답 지연 시 커널 메모리에 메시지 누적, 외부 API 미제공(네이티브 서비스 전용)

## 관련 개념

- [프로세스 간 통신 (IPC)](/knowledge/os/ipc-models/)
- [공유 메모리](/knowledge/os/shared-memory/)
- [APC와 DPC](/knowledge/os/apc-dpc/)
