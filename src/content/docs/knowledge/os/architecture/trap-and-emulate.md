---
title: "트랩 앤 에뮬레이트 (Trap-and-Emulate)"
description: "게스트 OS의 특권 명령어 실행 시 트랩을 발생시켜 VMM이 에뮬레이션하는 가상화 기법"
tags: ["OS", "Virtualization"]
created: 2026-01-28
updated: 2026-01-28
draft: true
slug: knowledge/os/trap-and-emulate
sidebar:
  order: 10
---

## 핵심 개념

Trap-and-Emulate는 게스트 OS가 특권 명령어를 실행하려 할 때 **트랩이 발생**하고, VMM이 이를 가로채 **에뮬레이션**하여 가상화를 구현하는 기법이다. 게스트 OS는 자신이 커널 모드에서 실행된다고 믿지만, 실제로는 사용자 모드에서 실행된다.

비유하면, 학교에서 학생(게스트)이 "교실 조명 끄기"(특권 명령)를 시도하면, 선생님(VMM)이 대신 조명을 끄고 학생에게 돌아가라고 하는 것이다.

## 동작 원리

### 실행 흐름

```
┌──────────────────────────────────────────┐
│            Guest OS                       │
│  ┌─────────────────────────────────────┐ │
│  │      User Processes                 │ │
│  │      (가상 사용자 모드)              │ │
│  └──────────────┬──────────────────────┘ │
│                 │ 시스템콜                │
│  ┌──────────────┴──────────────────────┐ │
│  │      Guest Kernel                   │ │
│  │      (가상 커널 모드)                │ │
│  │      특권 명령어 실행 시도 →  TRAP   │ │
│  └──────────────────────────────────────┘ │
└────────────────────────────────┬─────────┘
                                 │ 물리적으로는
                                 │ 사용자 모드
                                 ↓
┌──────────────────────────────────────────┐
│            VMM (물리 커널 모드)           │
│  1. 트랩 원인 확인                        │
│  2. 명령어 에뮬레이션                      │
│  3. VCPU 상태 업데이트                     │
│  4. 게스트로 리턴                          │
└──────────────────────────────────────────┘
```

1. 게스트 OS는 물리적 **사용자 모드**에서 실행
2. 게스트 커널이 특권 명령어를 실행하려 함
3. CPU가 **트랩 발생** → VMM으로 제어 전달
4. VMM이 해당 명령어의 동작을 에뮬레이션 (VCPU 상태 업데이트)
5. VMM이 게스트에게 제어권 반환

### VCPU (Virtual CPU)

VMM이 유지하는 각 게스트의 CPU 상태 데이터 구조:
- 가상 레지스터 값
- 가상 모드 (가상 사용자/커널 모드)
- 가상 인터럽트 플래그

### 성능 특성

- **비특권 명령어**: 네이티브 속도로 직접 실행 → 성능 좋음
- **특권 명령어**: 트랩 + 에뮬레이션 오버헤드 → 느림
- I/O 관련 명령어가 주로 특권이므로 I/O가 병목

### x86의 한계

일부 명령어가 사용자 모드에서도 **트랩 없이 실행**되는 문제:
- 예: `popf` — 커널 모드에서는 모든 플래그 변경, 사용자 모드에서는 일부만 변경하고 트랩 없음
- 이런 **"special instructions"** 때문에 순수 trap-and-emulate 불가능
- 해결책: **바이너리 변환(Binary Translation)** 또는 **하드웨어 가상화 지원(VT-x/AMD-V)**

## 예시

게스트 OS가 인터럽트를 비활성화하려 할 때:

```
Guest OS: CLI (인터럽트 비활성화 시도)
    │
    ↓ TRAP (사용자 모드에서 특권 명령어)
    │
VMM: VCPU의 가상 인터럽트 플래그를 비활성화로 설정
    │
    ↓ 게스트로 리턴
    │
Guest OS: 인터럽트가 비활성화되었다고 인식하고 계속 실행
```

## 관련 개념

- [가상화 (Virtualization)](/knowledge/os/virtualization/) - 가상화의 전체 개념
- [바이너리 변환 (Binary Translation)](/knowledge/os/binary-translation/) - 트랩이 불가능할 때의 대안
- [하드웨어 가상화 지원 (VT-x/AMD-V)](/knowledge/os/hw-virtualization/) - 하드웨어 수준 가상화 지원
- [하이퍼바이저 유형 (Type 0/1/2)](/knowledge/os/hypervisor-types/) - VMM의 구현 위치별 분류
