---
title: "트랩 앤 에뮬레이트 (Trap-and-Emulate)"
description: "게스트 OS의 특권 명령어 실행 시 트랩을 발생시켜 VMM이 에뮬레이션하는 가상화 기법"
tags: ["OS", "Virtualization"]
created: 2026-01-28
updated: 2026-01-28
draft: false
slug: knowledge/os/trap-and-emulate
sidebar:
  order: 4
---

import ArchitectureStack from '../../../../../components/ArchitectureStack.astro';
import StepFlow from '../../../../../components/StepFlow.astro';
import LayerStack from '../../../../../components/LayerStack.astro';

## 핵심 개념

Trap-and-Emulate는 게스트 OS가 특권 명령어를 실행하려 할 때 **트랩이 발생**하고, VMM이 이를 가로채 **에뮬레이션**하여 가상화를 구현하는 기법이다. 게스트 OS는 자신이 커널 모드에서 실행된다고 믿지만, 실제로는 사용자 모드에서 실행된다.

비유하면, 학교에서 학생(게스트)이 "교실 조명 끄기"(특권 명령)를 시도하면, 선생님(VMM)이 대신 조명을 끄고 학생에게 돌아가라고 하는 것이다.

## 동작 원리

### 실행 흐름

<div style="max-width: 360px; margin: 0 auto;">
<ArchitectureStack
  title="Guest OS 구조 (물리적으로는 사용자 모드)"
  topItems={[
    { label: "User Processes", description: "가상 사용자 모드" }
  ]}
  baseLayer={{ label: "Guest Kernel", description: "가상 커널 모드 — 특권 명령어 실행 시 TRAP", highlight: true }}
/>
</div>

<StepFlow
  title="Trap-and-Emulate 흐름"
  steps={[
    { label: "Guest OS 실행", description: "물리적 사용자 모드" },
    { label: "특권 명령어 시도", description: "게스트 커널이 실행" },
    { label: "TRAP 발생", description: "CPU가 VMM으로 제어 전달" },
    { label: "VMM 에뮬레이션", description: "VCPU 상태 업데이트" },
    { label: "게스트로 리턴", description: "제어권 반환" }
  ]}
  cycle={true}
/>

### VCPU (Virtual CPU)

VMM이 유지하는 각 게스트의 CPU 상태 데이터 구조:
- 가상 레지스터 값
- 가상 모드 (가상 사용자/커널 모드)
- 가상 인터럽트 플래그

### 성능 특성

| 명령어 유형 | 실행 방식 | 성능 |
|-------------|-----------|------|
| **비특권 명령어** | 네이티브 속도로 직접 실행 | 빠름 |
| **특권 명령어** | 트랩 + 에뮬레이션 오버헤드 | 느림 |

I/O 관련 명령어가 주로 특권이므로 I/O가 병목이 된다.

### x86의 한계

일부 명령어가 사용자 모드에서도 **트랩 없이 실행**되는 문제:
- 예: `popf` — 커널 모드에서는 모든 플래그 변경, 사용자 모드에서는 일부만 변경하고 트랩 없음
- 이런 **"special instructions"** 때문에 순수 trap-and-emulate 불가능
- 해결책: **바이너리 변환(Binary Translation)** 또는 **하드웨어 가상화 지원(VT-x/AMD-V)**

## 예시

게스트 OS가 인터럽트를 비활성화하려 할 때:

<StepFlow
  title="CLI 명령어 에뮬레이션"
  steps={[
    { label: "Guest OS: CLI", description: "인터럽트 비활성화 시도" },
    { label: "TRAP 발생", description: "사용자 모드에서 특권 명령어" },
    { label: "VMM 처리", description: "VCPU의 가상 인터럽트 플래그 비활성화" },
    { label: "게스트로 리턴", description: "인터럽트 비활성화됐다고 인식" }
  ]}
/>
