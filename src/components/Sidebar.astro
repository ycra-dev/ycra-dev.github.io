---
import MobileMenuFooter from 'virtual:starlight/components/MobileMenuFooter';
import SidebarPersister from '@astrojs/starlight/components/SidebarPersister.astro';
import SidebarSublist from '@astrojs/starlight/components/SidebarSublist.astro';

const { sidebar } = Astro.locals.starlightRoute;
const currentPath = Astro.url.pathname;

// Get children of a category, unwrapping the top-level label
function getChildren(items: typeof sidebar, label: string): typeof sidebar {
	const category = items.find(item => item.label === label);
	if (category && category.type === 'group' && category.entries) {
		return category.entries;
	}
	return [];
}

// Filter sidebar based on current path and unwrap top-level categories
function filterSidebar(items: typeof sidebar): typeof sidebar {
	// On home page, show nothing
	if (currentPath === '/' || currentPath === '/index') {
		return [];
	}
	// If on Blog pages, show only Blog children
	if (currentPath.startsWith('/blog')) {
		return getChildren(items, 'Blog');
	}
	// If on Knowledge pages, show only Knowledge children
	if (currentPath.startsWith('/knowledge')) {
		return getChildren(items, 'Knowledge');
	}
	// If on TIL pages, show only TIL children
	if (currentPath.startsWith('/til')) {
		return getChildren(items, 'TIL');
	}
	// On other pages, show all
	return items;
}

const filteredSidebar = filterSidebar(sidebar);
---

<SidebarPersister>
	<SidebarSublist sublist={filteredSidebar} />
</SidebarPersister>

<div class="md:sl-hidden">
	<MobileMenuFooter />
</div>
